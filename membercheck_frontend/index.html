<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.bootcss.com/qs/6.5.1/qs.min.js"></script>

</head>

<body>
    <h1>Member Check！</h1>
    <div id="app">
        {{ message }}
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">添加人员</h3>
            </div>
            <div class="panel-body">
                <div class="form-inline">

                    <label>Name:
                        <input @keyup.enter="add()" type="text" class="form-control" v-model="memName">
                    </label>
                    <label>Score:
                        <input type="text" class="form-control" v-model="memScore">
                    </label>
                    <label>
                        <input type="checkbox" v-model="leaderchecked"> leader
                    </label>
                    <label>
                        <input type="checkbox" v-model="teacherchecked"> teacher
                    </label>
                    <label>
                        <button type="button" @click="add()" class="btn btn-large btn-block btn-primary">添加</button>
                    </label>
                </div>
                <div class="form-inline">
                    <label>搜索</label>


                    <div class="input-group">
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">All <span class="caret"></span></button>
                            <ul class="dropdown-menu">
                                <li><a href="#">All</a></li>
                                <li><a href="#">Student</a></li>
                                <li><a href="#">Leader</a></li>
                                <li><a href="#">Teacher</a></li>
                            </ul>
                        </div><!-- /btn-group -->
                        <input type="text" class="form-control" v-model="keyword" placeholder="Search for..." v-focus>
                    </div><!-- /input-group -->


                </div>
            </div>
        </div>

        <div id="dataerror" class="alert alert-danger alert-dismissible hidden" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
            <strong>错误!</strong> 无法获取数据
        </div>

        <table class="table table-bordered table-hover table-striped">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Name</th>
                    <th>Score</th>
                    <th>Ctime</th>
                    <th>Role</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(item, memId) in search(keyword)" :key="listitem.memId">
                    <td v-text="item.memId"></td>
                    <td><span class="glyphicon glyphicon-user" v-text="item.memName"></span></td>
                    <td v-text="item.memScore"></td>
                    <td>{{item.memCtime | dataFormate}}</td>
                    <td>
                        <span v-if="getroles(item.memRole).indexOf('student') > -1" class="label label-info"
                            style="margin:5px">student</span>
                        <span v-if="getroles(item.memRole).indexOf('leader') > -1" class="label label-success"
                            style="margin:5px">leader</span>
                        <span v-if="getroles(item.memRole).indexOf('teacher') > -1" class="label label-danger"
                            style="margin:5px">teacher</span>
                    </td>
                    <td><a href="#" @click.prevent="del(item.memId)">delete</a></td>
                </tr>
            </tbody>
        </table>

    </div>
    <script>
        axios.defaults.baseURL = 'http://127.0.0.1:8080';
        axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';

        Vue.filter('dataFormate', function (data) {
            var dt = new Date(data);
            var y = dt.getFullYear();
            var m = (dt.getMonth() + 1).toString().padStart(2, '0');
            var d = dt.getDate().toString().padStart(2, '0');

            return `${y}-${m}-${d}`;
        });

        Vue.filter('rolefilter', function (data) {

        });

        Vue.directive('focus', {
            bind: function (el) {

            },
            inserted: function (el) {
                el.focus();
            },
            updated: function (el) {

            },
        });

        var app = new Vue({
            el: '#app',
            data: {
                memId: 0,
                memName: '未命名',
                memScore: 0,
                memRole: 'student',
                message: 'Built by thebestwj!',
                leaderchecked: true,
                teacherchecked: false,
                keyword: "",
                listitem: [

                ]
            },
            created() {
                this.getall();
            },
            methods: {
                getroles(data) {
                    var ss = data.split(',');
                    return ss;
                },
                add() {
                    var member = {
                        //memId:this.memId,
                        memName: this.memName,
                        memCtime: new Date(),
                        memScore: this.memScore,
                        memRole: 'student',
                    }

                    if (this.leaderchecked) member.memRole = member.memRole + ',leader';
                    if (this.teacherchecked) member.memRole = member.memRole + ',teacher'

                    axios.post('/member', member)
                        .then(res => {
                            console.log(res)
                            if (res.data <= 0) $('#dataerror').removeClass('hidden');
                            member.memId = res.data;
                            this.listitem.push(member);
                        })
                        .catch(err => {
                            console.error(err);
                            $('#dataerror').removeClass('hidden');
                        })


                },
                del(id) {
                    this.listitem.some((item, i) => {
                        if (item.memId == id) {
                            axios.delete('/member/' + id)
                                .then(res => {
                                    console.log('delete ' + id);
                                    this.listitem.splice(i, 1);
                                    return true;
                                })
                                .catch(err => {
                                    console.error(err);
                                });

                        }
                    })
                },
                search(keyword) {
                    var resultlist = [];
                    this.listitem.forEach(item => {
                        if (item.memName.indexOf(keyword) != -1) {
                            resultlist.push(item);
                        }
                    });
                    return resultlist;
                },
                getall() {
                    console.log('ok');
                    axios.get('/members/student')
                        .then(res => {
                            console.log(res.data)
                            res.data.forEach(element => {
                                this.listitem.push(element);
                            });
                        })
                        .catch(err => {
                            console.error(err);
                            $('#dataerror').removeClass('hidden');
                        });
                }
            },
        });
    </script>

    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
</body>

</html>